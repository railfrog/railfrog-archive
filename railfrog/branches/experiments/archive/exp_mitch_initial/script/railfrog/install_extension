#!/usr/bin/env ruby

def load_extensions_array
  extensions = []

  Dir.foreach(Extension.path) do |ext_file|
    if File.exists?(Extension.generate_filename(ext_file)) and File.exists?(Extension.generate_yaml_filename(ext_file)) then
      yaml_data = Extension.load_yaml_data(ext_file)
      require_dependency Extension.generate_filename(ext_file)
      eval 'yaml_data[\'type\'] = ' + Extension.generate_classname(ext_file) + '.type'
      extensions.push(yaml_data)
    end
  end
  
  return extensions
end

print 'Loading railfrog system...'
require 'config/environment'
puts 'Done'

print "\n"
puts '=== INSTALL AN EXTENSION IN RAILFROG ==='
print 'Extension name: '
ext_name = $stdin.gets.chomp

if Extension.exists?(ext_name)
  print "\n"
  puts "ERROR: #{ext_name} is already installed."
  exit
end

extensions = load_extensions_array
if extensions.detect { |inext| inext.raw_name.downcase == ext_name.downcase }.nil?
  print "\n"
  puts "ERROR: Failed to locate #{ext_name}. Check:"
  puts "1. Extension is in:\n#{Extension.path}/#{ext_name}"
  puts "2. Main file exists:\n#{Extension.generate_filename(ext_name)}"
  puts "3. Information file exists:\n#{Extension.generate_yaml_filename(ext_name)}"
  exit
end

extension = Extension.install(ext_name)
begin
  unless extension.ext_cmd_install(extension)
    extension.destroy
    exit
  end
rescue NoMethodError
end

print "\n"
puts 'Extension installed!'
extension.finalize