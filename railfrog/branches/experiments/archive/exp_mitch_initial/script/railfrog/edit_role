#!/usr/bin/env ruby

print 'Loading railfrog system...'
require 'config/environment'
puts 'Done'

print "\n"
puts "=== EDIT ROLE ==="
print 'Role name: '
role_name = $stdin.gets.chomp

roles = Role.find(:all)
if roles.empty?
  print "\n"
  puts 'No roles.'
  exit
end

role = roles.detect { |role| role.name == role_name or role.translate == role_name }

if role.nil?
  print "\n"
  puts "ERROR: Couldn't find role named '#{role_name}'"
  exit
end

print 'Translated name, or leave blank to keep the same: '
role_tr_name = $stdin.gets.chomp

print 'Permissions, separated by a comma, or leave blank to keep the same: '
perm_names = $stdin.gets.chomp.split(',').collect { |p| p.strip }

unless perm_names.empty?
  perms = Permission.find(:all)
  if perms.empty? and !perm_names.empty?
    print "\n"
    puts 'No permissions. That can\'t be good.'
    exit
  end
  
  perms_to_add = []
  perm_names.each do |perm_name|
    perm = perms.detect { |perm| perm.name == perm_name or perm.translate == perm_name }
    
    if perm.nil?
      print "\n"
      print "ERROR: Couldn't find permission named '#{perm_name}'"
      exit
    end
    
    perms_to_add.push(perm)
  end
  
  perms.each { |perm| role.set_permission(perm, 0) }
  
  perms_to_add.each do |perm|
    role.set_permission(perm, 1)
  end
end

role.set(role_tr_name) unless role_tr_name.empty?

print "\n"
puts "Edited role '#{role_name}'"